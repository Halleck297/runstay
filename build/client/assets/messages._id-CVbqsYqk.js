import{j as e}from"./jsx-runtime-0DLF9kdB.js";import{r as i,u as I,a as O,d as T,e as W,L as C,F as L}from"./components-Oo-HIKtb.js";import{g as D}from"./supabase.client-CjZ7LRWJ.js";function q({conversationId:m,initialMessages:r,currentUserId:h,onNewMessage:l}){var y;const[j,u]=i.useState(r),[w,g]=i.useState(!1),p=(y=r[r.length-1])==null?void 0:y.id,x=r.length;i.useEffect(()=>{u(a=>{var o;if(x>a.length)return r;const d=(o=a[a.length-1])==null?void 0:o.id;return p&&p!==d&&!a.some(s=>s.id===p)?r:a})},[m,x,p,r]);const N=i.useCallback(async a=>{try{await D().from("messages").update({read_at:new Date().toISOString()}).eq("id",a)}catch(d){console.error("Error marking message as read:",d)}},[]);return i.useEffect(()=>{if(!m||typeof window>"u")return;let a;return(()=>{try{a=D().channel(`messages:${m}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${m}`},s=>{const n=s.new;u(f=>f.some(b=>b.id===n.id)?f:[...f,n]),n.sender_id!==h&&N(n.id),l==null||l(n)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${m}`},s=>{const n=s.new;u(f=>f.map(b=>b.id===n.id?n:b))}).subscribe(s=>{g(s==="SUBSCRIBED")})}catch(o){console.error("Error setting up realtime:",o)}})(),()=>{a&&D().removeChannel(a)}},[m,h,N,l]),{messages:j,isConnected:w,setMessages:u}}const F=()=>[{title:"Conversation - Runoot"}];function P(){var S,_,R,E;const{user:m,conversation:r,isBlocked:h}=I(),l=O(),j=T();W();const u=i.useRef(null),w=i.useRef(null),g=i.useRef(null),[p,x]=i.useState(!1),[N,y]=i.useState(!1),a=i.useRef(null),d=j.state==="submitting",o=m.id,s=r.participant_1===o?r.participant2:r.participant1,{messages:n,setMessages:f}=q({conversationId:r.id,initialMessages:r.messages||[],currentUserId:o});i.useEffect(()=>{function t(c){a.current&&!a.current.contains(c.target)&&x(!1)}return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]);const b=t=>{const c={id:`temp-${Date.now()}`,conversation_id:r.id,sender_id:o,content:t,created_at:new Date().toISOString(),read_at:null};f(v=>[...v,c])};i.useEffect(()=>{var t;j.state==="idle"&&l&&"success"in l&&l.success&&((t=u.current)==null||t.reset(),g.current&&(g.current.style.height="auto"),x(!1))},[j.state,l]),i.useEffect(()=>{var t;(t=w.current)==null||t.scrollIntoView({behavior:"smooth"})},[n]);const M=t=>{var c;t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),(c=u.current)==null||c.requestSubmit())},A=t=>{t.target.style.height="auto",t.target.style.height=Math.min(t.target.scrollHeight,150)+"px"};return e.jsxs("div",{className:"flex-1 flex flex-col bg-white border border-gray-200 rounded-r-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-4 p-4 border-b border-gray-200 bg-white h-[72px]",children:[e.jsx(C,{to:"/messages",className:"md:hidden text-gray-400 hover:text-gray-600 flex-shrink-0",children:e.jsx("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-brand-100 text-brand-700 font-semibold flex-shrink-0",children:((S=s==null?void 0:s.company_name)==null?void 0:S.charAt(0))||((_=s==null?void 0:s.full_name)==null?void 0:_.charAt(0))||"?"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("p",{className:"font-medium text-gray-900 truncate flex items-center gap-1",children:[(s==null?void 0:s.company_name)||(s==null?void 0:s.full_name)||"User",(s==null?void 0:s.is_verified)&&e.jsx("svg",{className:"h-4 w-4 text-brand-500",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),h&&e.jsx("span",{className:"text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full ml-2",children:"Blocked"})]}),e.jsx(C,{to:`/listings/${(R=r.listing)==null?void 0:R.id}`,className:"text-sm text-brand-600 hover:text-brand-700 truncate block",children:(E=r.listing)==null?void 0:E.title})]}),e.jsxs("div",{className:"relative",ref:a,children:[e.jsx("button",{type:"button",onClick:()=>x(!p),className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg",children:e.jsx("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"})})}),p&&e.jsxs("div",{className:"absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50",children:[e.jsxs(L,{method:"post",children:[e.jsx("input",{type:"hidden",name:"intent",value:h?"unblock":"block"}),e.jsxs("button",{type:"submit",className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50",children:[e.jsx("svg",{className:"h-4 w-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"})}),h?"Unblock user":"Block user"]})]}),e.jsxs(C,{to:`/report?type=user&id=${s==null?void 0:s.id}&from=conversation`,className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50",onClick:()=>x(!1),children:[e.jsx("svg",{className:"h-4 w-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),"Report"]}),e.jsx("div",{className:"border-t border-gray-100 my-1"}),e.jsxs("button",{type:"button",onClick:()=>{x(!1),y(!0)},className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50",children:[e.jsx("svg",{className:"h-4 w-4 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"Delete conversation"]})]})]})]}),N&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-sm w-full p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Delete conversation?"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"This conversation will be removed from your inbox. The other user will still be able to see it."}),e.jsxs("div",{className:"mt-4 flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>y(!1),className:"btn-secondary",children:"Cancel"}),e.jsxs(L,{method:"post",children:[e.jsx("input",{type:"hidden",name:"intent",value:"delete"}),e.jsx("button",{type:"submit",className:"btn-primary bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-8 py-4",children:e.jsxs("div",{className:"space-y-3",children:[n==null?void 0:n.map((t,c)=>{const v=t.sender_id===o,k=new Date(t.created_at),z=n[c-1],B=z?new Date(z.created_at):null,$=!B||k.toDateString()!==B.toDateString();return e.jsxs("div",{children:[$&&e.jsxs("div",{className:"flex items-center gap-4 my-6",children:[e.jsx("div",{className:"flex-1 h-px bg-gray-200"}),e.jsx("span",{className:"text-xs text-gray-400 font-medium",children:k.toLocaleDateString([],{weekday:"short",day:"numeric",month:"short"})}),e.jsx("div",{className:"flex-1 h-px bg-gray-200"})]}),e.jsx("div",{className:`flex ${v?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-2xl px-4 py-2.5 ${v?"bg-gray-200 text-gray-900 rounded-br-md":"bg-accent-500 text-white rounded-bl-md"}`,children:[e.jsx("p",{className:"whitespace-pre-wrap break-words",children:t.content}),e.jsxs("div",{className:`flex items-center justify-end gap-1.5 text-xs mt-1 ${v?"text-gray-500":"text-accent-100"}`,children:[e.jsx("span",{children:k.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),v&&e.jsx("span",{className:"flex items-center",children:t.read_at?e.jsx("svg",{className:"w-4 h-4 text-blue-500",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"})}):e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"})})})]})]})})]},t.id)}),e.jsx("div",{ref:w})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-4 bg-white",children:[l&&"error"in l&&e.jsx("p",{className:"text-sm text-red-600 mb-2",children:l.error}),h?e.jsx("p",{className:"text-sm text-gray-500 text-center py-2",children:"You have blocked this user. Unblock to send messages."}):e.jsxs(L,{ref:u,method:"post",className:"flex gap-3 items-end",onSubmit:()=>{var c;const t=(c=g.current)==null?void 0:c.value;t!=null&&t.trim()&&b(t.trim())},children:[e.jsx("textarea",{ref:g,name:"content",placeholder:"Type your message... (Shift+Enter for new line)",autoComplete:"off",required:!0,rows:1,className:"input flex-1 resize-none py-3 min-h-[48px] max-h-[150px]",disabled:d,onKeyDown:M,onChange:A}),e.jsx("button",{type:"submit",disabled:d,className:"btn-primary px-4 h-12 flex items-center justify-center",children:d?e.jsxs("svg",{className:"animate-spin h-5 w-5",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})]})]})}export{P as default,F as meta};
