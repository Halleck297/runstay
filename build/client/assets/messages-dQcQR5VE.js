import{r as c,d as w,w as v,u as N,h as b,j as e,L as j,O as _}from"./chunk-JZWAC4HX-Wpy6LLBq.js";import{H as L}from"./Header-DbNBnIdE.js";import{g as M}from"./avatarColors-CZJ_YuDz.js";const k=5e3;function $({userId:d,initialConversations:n}){const[o,i]=c.useState(n),t=w(),r=c.useRef(!1);return c.useEffect(()=>{i(n)},[n]),c.useEffect(()=>{var a;(a=t.data)!=null&&a.conversations&&t.state==="idle"&&i(t.data.conversations)},[t.data,t.state]),c.useEffect(()=>{if(!d||typeof window>"u")return;const s=setInterval(()=>{r.current||t.state==="idle"&&(r.current=!0,t.load("/api/conversations"),r.current=!1)},k);return()=>{clearInterval(s)}},[d,t]),{conversations:o,setConversations:i}}function C(d){const n=new Date(d),i=new Date().getTime()-n.getTime(),t=Math.floor(i/6e4),r=Math.floor(i/36e5),a=Math.floor(i/864e5);return t<1?"now":t<60?`${t}m`:r<24?`${r}h`:a<7?`${a}d`:n.toLocaleDateString()}const T=v(function(){const{user:n,conversations:o}=N(),t=b().id,{conversations:r}=$({userId:n.id,initialConversations:o});return e.jsxs("div",{className:"h-screen flex flex-col bg-gray-50",children:[e.jsx(L,{user:n}),e.jsx("div",{className:"flex-1 overflow-hidden bg-cover bg-center bg-no-repeat",style:{backgroundImage:"url('/messages.webp')"},children:e.jsx("div",{className:"mx-auto max-w-7xl h-full px-4 sm:px-6 lg:px-8 py-16",children:e.jsxs("div",{className:"flex h-full rounded-lg shadow-xl overflow-hidden",children:[e.jsxs("aside",{className:`w-full md:w-80 lg:w-96 bg-white/95 backdrop-blur-sm rounded-l-lg flex flex-col overflow-hidden border-r border-gray-200 ${t?"hidden md:flex":"flex"}`,children:[e.jsx("div",{className:"p-4 border-b border-gray-200 flex items-center h-[72px]",children:e.jsx("h1",{className:"font-display text-xl font-bold text-gray-900",children:"Messages"})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:r.length>0?e.jsx("div",{className:"divide-y divide-gray-100",children:r.map(a=>{var u,g,h,p;const s=a.participant_1===n.id?a.participant2:a.participant1,l=[...a.messages||[]].sort((m,y)=>new Date(y.created_at).getTime()-new Date(m.created_at).getTime())[0],x=(u=a.messages)==null?void 0:u.filter(m=>m.sender_id!==n.id&&!m.read_at).length,f=a.id===t;return e.jsxs(j,{to:`/messages/${a.id}`,className:`flex items-center gap-3 p-4 hover:bg-gray-50 transition-colors ${f?"bg-gray-100":""}`,children:[e.jsx("div",{className:`flex h-12 w-12 items-center justify-center rounded-full font-semibold flex-shrink-0 ${f?"bg-brand-500 text-white":M((s==null?void 0:s.id)||"",s==null?void 0:s.user_type)}`,children:((g=s==null?void 0:s.company_name)==null?void 0:g.charAt(0))||((h=s==null?void 0:s.full_name)==null?void 0:h.charAt(0))||"?"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:`font-medium truncate text-sm ${x>0?"text-gray-900":"text-gray-600"}`,children:(s==null?void 0:s.company_name)||(s==null?void 0:s.full_name)||"User"}),l&&e.jsx("span",{className:"text-xs text-gray-400 flex-shrink-0",children:C(l.created_at)})]}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:((p=a.listing)==null?void 0:p.title)||"Listing"}),l&&e.jsx("p",{className:`text-sm truncate mt-0.5 ${x>0?"text-gray-900 font-medium":"text-gray-500"}`,children:l.sender_id===n.id?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-400",children:"You: "}),l.message_type==="heart"?"Listing saved":l.content]}):l.message_type==="heart"?"Listing saved":l.translated_content||"New message"})]}),x>0&&!f&&e.jsx("div",{className:"h-3 w-3 rounded-full bg-red-500 flex-shrink-0"})]},a.id)})}):e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-300",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),e.jsx("p",{className:"mt-4 text-sm text-gray-500",children:"No messages yet"}),e.jsx(j,{to:"/listings",className:"mt-4 btn-primary inline-block text-sm",children:"Browse Listings"})]})})]}),e.jsx("main",{className:`flex-1 flex flex-col ${t?"flex":"hidden md:flex"}`,children:e.jsx(_,{context:{user:n,conversations:r}})})]})})})]})});export{T as default};
