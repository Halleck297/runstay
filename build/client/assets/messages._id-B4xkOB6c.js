import{r,c as O,w as W,u as I,a as H,d as V,h as F,j as e,L as k,F as L}from"./chunk-JZWAC4HX-CFbAysJh.js";const K=3e3;function P({conversationId:j,initialMessages:h,currentUserId:i,onNewMessage:d}){const[x,u]=r.useState(h),a=O(),f=r.useRef(!1),m=r.useRef(h.length);return r.useEffect(()=>{u(h),m.current=h.length},[j]),r.useEffect(()=>{var p;if((p=a.data)!=null&&p.messages&&a.state==="idle"){const n=a.data.messages;u(b=>{const g=b.filter(l=>l.id.startsWith("temp-")).filter(l=>!n.some(s=>s.sender_id===l.sender_id&&s.content===l.content));return m.current<n.length&&n.slice(m.current).forEach(c=>{c.sender_id!==i&&(d==null||d(c))}),m.current=n.length,g.length>0?[...n,...g].sort((l,c)=>new Date(l.created_at).getTime()-new Date(c.created_at).getTime()):n})}},[a.data,a.state,i,d]),r.useEffect(()=>{if(!j||typeof window>"u")return;const n=setInterval(()=>{f.current||a.state==="idle"&&(f.current=!0,a.load(`/api/messages/${j}`),f.current=!1)},K);return()=>{clearInterval(n)}},[j,a]),{messages:x,isConnected:!0,setMessages:u}}const Y=()=>[{title:"Conversation - Runoot"}],G=W(function(){var C,D,M,_;const{user:h,conversation:i,isBlocked:d}=I(),x=H(),u=V();F();const a=r.useRef(null),f=r.useRef(null),m=r.useRef(null),[p,n]=r.useState(!1),[b,w]=r.useState(!1),g=r.useRef(null),l=u.state==="submitting",c=h.id,s=i.participant_1===c?i.participant2:i.participant1,{messages:y,setMessages:z}=P({conversationId:i.id,initialMessages:i.messages||[],currentUserId:c});r.useEffect(()=>{function t(o){g.current&&!g.current.contains(o.target)&&n(!1)}return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]);const E=t=>{const o={id:`temp-${Date.now()}`,conversation_id:i.id,sender_id:c,content:t,created_at:new Date().toISOString(),read_at:null};z(v=>[...v,o])};r.useEffect(()=>{var t;u.state==="idle"&&x&&"success"in x&&x.success&&((t=a.current)==null||t.reset(),m.current&&(m.current.style.height="auto"),n(!1))},[u.state,x]),r.useEffect(()=>{var t;(t=f.current)==null||t.scrollIntoView({behavior:"smooth"})},[y]);const B=t=>{var o;t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),(o=a.current)==null||o.requestSubmit())},T=t=>{t.target.style.height="auto",t.target.style.height=Math.min(t.target.scrollHeight,150)+"px"};return e.jsxs("div",{className:"flex-1 flex flex-col bg-white border border-gray-200 rounded-r-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-4 p-4 border-b border-gray-200 bg-white h-[72px]",children:[e.jsx(k,{to:"/messages",className:"md:hidden text-gray-400 hover:text-gray-600 flex-shrink-0",children:e.jsx("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-brand-100 text-brand-700 font-semibold flex-shrink-0",children:((C=s==null?void 0:s.company_name)==null?void 0:C.charAt(0))||((D=s==null?void 0:s.full_name)==null?void 0:D.charAt(0))||"?"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("p",{className:"font-medium text-gray-900 truncate flex items-center gap-1",children:[(s==null?void 0:s.company_name)||(s==null?void 0:s.full_name)||"User",(s==null?void 0:s.is_verified)&&e.jsx("svg",{className:"h-4 w-4 text-brand-500",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),d&&e.jsx("span",{className:"text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full ml-2",children:"Blocked"})]}),e.jsx(k,{to:`/listings/${(M=i.listing)==null?void 0:M.id}`,className:"text-sm text-brand-600 hover:text-brand-700 truncate block",children:(_=i.listing)==null?void 0:_.title})]}),e.jsxs("div",{className:"relative",ref:g,children:[e.jsx("button",{type:"button",onClick:()=>n(!p),className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg",children:e.jsx("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"})})}),p&&e.jsxs("div",{className:"absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50",children:[e.jsxs(L,{method:"post",children:[e.jsx("input",{type:"hidden",name:"intent",value:d?"unblock":"block"}),e.jsxs("button",{type:"submit",className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50",children:[e.jsx("svg",{className:"h-4 w-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"})}),d?"Unblock user":"Block user"]})]}),e.jsxs(k,{to:`/report?type=user&id=${s==null?void 0:s.id}&from=conversation`,className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50",onClick:()=>n(!1),children:[e.jsx("svg",{className:"h-4 w-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),"Report"]}),e.jsx("div",{className:"border-t border-gray-100 my-1"}),e.jsxs("button",{type:"button",onClick:()=>{n(!1),w(!0)},className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50",children:[e.jsx("svg",{className:"h-4 w-4 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"Delete conversation"]})]})]})]}),b&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-sm w-full p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Delete conversation?"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"This conversation will be removed from your inbox. The other user will still be able to see it."}),e.jsxs("div",{className:"mt-4 flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>w(!1),className:"btn-secondary",children:"Cancel"}),e.jsxs(L,{method:"post",children:[e.jsx("input",{type:"hidden",name:"intent",value:"delete"}),e.jsx("button",{type:"submit",className:"btn-primary bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-8 py-4",children:e.jsxs("div",{className:"space-y-3",children:[y==null?void 0:y.map((t,o)=>{const v=t.sender_id===c,N=new Date(t.created_at),R=y[o-1],S=R?new Date(R.created_at):null,A=t.message_type==="heart",$=!S||N.toDateString()!==S.toDateString();return e.jsxs("div",{children:[$&&e.jsxs("div",{className:"flex items-center gap-4 my-6",children:[e.jsx("div",{className:"flex-1 h-px bg-gray-200"}),e.jsx("span",{className:"text-xs text-gray-400 font-medium",children:N.toLocaleDateString([],{weekday:"short",day:"numeric",month:"short"})}),e.jsx("div",{className:"flex-1 h-px bg-gray-200"})]}),A?e.jsx("div",{className:"flex justify-center my-6",children:e.jsxs("div",{className:"border border-gray-200 bg-white rounded-2xl px-6 py-4 text-center max-w-sm shadow-sm",children:[e.jsx("div",{className:"flex justify-center mb-2",children:e.jsx("svg",{className:"h-8 w-8 text-red-500",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"})})}),e.jsx("p",{className:"text-gray-800 font-medium",children:"Your listing caught someone's eye"}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"This user saved your listing. Start a conversation."})]})}):e.jsx("div",{className:`flex ${v?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-2xl px-4 py-2.5 ${v?"bg-gray-200 text-gray-900 rounded-br-md":"bg-accent-500 text-white rounded-bl-md"}`,children:[e.jsx("p",{className:"whitespace-pre-wrap break-words",children:t.content}),e.jsxs("div",{className:`flex items-center justify-end gap-1.5 text-xs mt-1 ${v?"text-gray-500":"text-accent-100"}`,children:[e.jsx("span",{children:N.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),v&&e.jsx("span",{className:"flex items-center",children:t.read_at?e.jsx("svg",{className:"w-4 h-4 text-blue-500",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"})}):e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"})})})]})]})})]},t.id)}),e.jsx("div",{ref:f})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-4 bg-white",children:[x&&"error"in x&&e.jsx("p",{className:"text-sm text-red-600 mb-2",children:x.error}),d?e.jsx("p",{className:"text-sm text-gray-500 text-center py-2",children:"You have blocked this user. Unblock to send messages."}):e.jsxs(L,{ref:a,method:"post",className:"flex gap-3 items-end",onSubmit:()=>{var o;const t=(o=m.current)==null?void 0:o.value;t!=null&&t.trim()&&E(t.trim())},children:[e.jsx("textarea",{ref:m,name:"content",placeholder:"Type your message... (Shift+Enter for new line)",autoComplete:"off",required:!0,rows:1,className:"input flex-1 resize-none py-3 min-h-[48px] max-h-[150px] overflow-hidden rounded-2xl",disabled:l,onKeyDown:B,onChange:T}),e.jsx("button",{type:"submit",disabled:l,className:"btn-primary px-4 h-12 flex items-center justify-center rounded-2xl",children:l?e.jsxs("svg",{className:"animate-spin h-5 w-5",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 5l7 7m0 0l-7 7m7-7H3"})})})]})]})]})});export{G as default,Y as meta};
