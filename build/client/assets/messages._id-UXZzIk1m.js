import{r as l,e as se,w as ne,u as ae,a as re,b as le,c as ie,j as e,L as O,F as D}from"./chunk-JZWAC4HX-Dlc7LzsC.js";import{g as oe}from"./avatarColors-CZJ_YuDz.js";const ce=3e3;function de(){if(!(typeof window>"u"))try{const i=new Audio("/ding-sound.mp3");i.volume=.5,i.play().catch(()=>{})}catch{}}function ue({conversationId:i,initialMessages:v,currentUserId:c,onNewMessage:d}){const[u,m]=l.useState(v),g=se(),p=l.useRef(!1),f=l.useRef(v.length);return l.useEffect(()=>{m(v),f.current=v.length},[i]),l.useEffect(()=>{var w;if((w=g.data)!=null&&w.messages&&g.state==="idle"){const x=g.data.messages;m(t=>{const r=t.filter(o=>o.id.startsWith("temp-")).filter(o=>!x.some(n=>n.sender_id===o.sender_id&&n.content===o.content));if(f.current<x.length){const o=x.slice(f.current);let h=!1;o.forEach(n=>{n.sender_id!==c&&(d==null||d(n),h=!0)}),h&&de()}return f.current=x.length,r.length>0?[...x,...r].sort((o,h)=>new Date(o.created_at).getTime()-new Date(h.created_at).getTime()):x})}},[g.data,g.state,c,d]),l.useEffect(()=>{if(!i||typeof window>"u")return;const x=setInterval(()=>{p.current||g.state==="idle"&&(p.current=!0,g.load(`/api/messages/${i}`),p.current=!1)},ce);return()=>{clearInterval(x)}},[i,g]),{messages:u,isConnected:!0,setMessages:m}}function xe({userId:i,messages:v,enabled:c=!0}){const[d,u]=l.useState({}),[m,g]=l.useState("en"),p=l.useRef(new Set);l.useEffect(()=>{var s;const t=((s=navigator.language)==null?void 0:s.split("-")[0])||"en";g(t)},[]);const f=l.useCallback(async t=>{const s=t.id;if(!s.startsWith("temp-")&&t.sender_id!==i&&!p.current.has(s)){if(t.translated_content&&t.translated_to===m){u(r=>({...r,[s]:{translatedContent:t.translated_content,detectedLanguage:t.detected_language||null,isLoading:!1,error:null,showOriginal:!1}}));return}if(t.detected_language===m){u(r=>({...r,[s]:{translatedContent:null,detectedLanguage:t.detected_language,isLoading:!1,error:null,showOriginal:!1}}));return}p.current.add(s),u(r=>({...r,[s]:{translatedContent:null,detectedLanguage:null,isLoading:!0,error:null,showOriginal:!1}}));try{const r=await fetch("/api/translate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messageId:s,targetLanguage:m})}),o=await r.json();if(!r.ok)throw new Error(o.error||"Translation failed");u(h=>({...h,[s]:{translatedContent:o.translatedContent,detectedLanguage:o.detectedLanguage,isLoading:!1,error:null,showOriginal:!1}}))}catch(r){console.error("Translation error:",r),u(o=>({...o,[s]:{translatedContent:null,detectedLanguage:null,isLoading:!1,error:r instanceof Error?r.message:"Translation failed",showOriginal:!1}}))}finally{p.current.delete(s)}}},[i,m]);l.useEffect(()=>{c&&v.forEach(t=>{var s,r;((s=d[t.id])==null?void 0:s.translatedContent)===void 0&&((r=d[t.id])!=null&&r.isLoading||f(t))})},[v,c,f,d]);const w=l.useCallback(t=>{u(s=>{var r;return{...s,[t]:{...s[t],showOriginal:!((r=s[t])!=null&&r.showOriginal)}}})},[]),x=l.useCallback(t=>{const s=d[t.id];return t.sender_id===i?{content:t.content,isTranslated:!1,isLoading:!1,showOriginal:!1,canToggle:!1}:s?s.isLoading?{content:t.content,isTranslated:!1,isLoading:!0,showOriginal:!1,canToggle:!1}:s.translatedContent?s.showOriginal?{content:t.content,isTranslated:!1,isLoading:!1,showOriginal:!0,canToggle:!0,originalContent:t.content,translatedContent:s.translatedContent}:{content:s.translatedContent,isTranslated:!0,isLoading:!1,showOriginal:!1,canToggle:!0,originalContent:t.content,translatedContent:s.translatedContent}:{content:t.content,isTranslated:!1,isLoading:!1,showOriginal:!1,canToggle:!1}:{content:t.content,isTranslated:!1,isLoading:!1,showOriginal:!1,canToggle:!1}},[d,i]);return{translations:d,browserLanguage:m,translateMessage:f,toggleShowOriginal:w,getDisplayContent:x}}const he=()=>[{title:"Conversation - Runoot"}];function me(i){return i?i.slug?i.slug:i.name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,""):""}const pe=ne(function(){var z,B,$,A,W,F,H,P;const{user:v,conversation:c,isBlocked:d}=ae(),u=re(),m=le();ie();const g=l.useRef(null),p=l.useRef(null),f=l.useRef(null),[w,x]=l.useState(!1),[t,s]=l.useState(!1),r=l.useRef(null),o=m.state==="submitting",h=v.id,n=c.participant_1===h?c.participant2:c.participant1,G=me((z=c.listing)==null?void 0:z.event),[C,_]=l.useState("png"),E=C?`/logos/${G}.${C}`:null,{messages:N,setMessages:K}=ue({conversationId:c.id,initialMessages:c.messages||[],currentUserId:h}),{getDisplayContent:R,toggleShowOriginal:Q}=xe({userId:h,messages:N,enabled:!0});l.useEffect(()=>{function a(y){r.current&&!r.current.contains(y.target)&&x(!1)}return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[]);const X=a=>{const y={id:`temp-${Date.now()}`,conversation_id:c.id,sender_id:h,content:a,created_at:new Date().toISOString(),read_at:null};K(j=>[...j,y])};l.useEffect(()=>{var a;m.state==="idle"&&u&&"success"in u&&u.success&&((a=g.current)==null||a.reset(),f.current&&(f.current.style.height="auto"),x(!1))},[m.state,u]),l.useEffect(()=>{var a;(a=p.current)==null||a.scrollIntoView({behavior:"smooth"})},[N]);const Z=a=>{a.target.style.height="auto",a.target.style.height=Math.min(a.target.scrollHeight,150)+"px"};return e.jsxs("div",{className:"flex-1 flex flex-col bg-white/95 backdrop-blur-sm md:rounded-r-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-4 p-4 border-b border-gray-200 h-[72px]",children:[e.jsx(O,{to:"/messages",className:"md:hidden text-gray-400 hover:text-gray-600 flex-shrink-0",children:e.jsx("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-lg overflow-hidden bg-gray-100 flex items-center justify-center",children:E?e.jsx("img",{src:E,alt:`${(($=(B=c.listing)==null?void 0:B.event)==null?void 0:$.name)||"Event"} logo`,className:"w-full h-full object-contain p-0.5",onError:()=>{_(C==="png"?"jpg":C==="jpg"?"webp":null)}}):e.jsx("span",{className:"text-xs font-semibold text-gray-400",children:((F=(W=(A=c.listing)==null?void 0:A.event)==null?void 0:W.name)==null?void 0:F.substring(0,2).toUpperCase())||"?"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("p",{className:"font-medium text-gray-900 truncate flex items-center gap-1",children:[(n==null?void 0:n.company_name)||(n==null?void 0:n.full_name)||"User",(n==null?void 0:n.is_verified)&&e.jsx("svg",{className:"h-4 w-4 text-brand-500",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),d&&e.jsx("span",{className:"text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full ml-2",children:"Blocked"})]}),e.jsx(O,{to:`/listings/${(H=c.listing)==null?void 0:H.id}`,className:"text-sm text-brand-600 hover:text-brand-700 truncate block",children:(P=c.listing)==null?void 0:P.title})]}),e.jsxs("div",{className:"relative",ref:r,children:[e.jsx("button",{type:"button",onClick:()=>x(!w),className:"p-3 -m-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center",children:e.jsx("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"})})}),w&&e.jsxs("div",{className:"absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50",children:[e.jsxs(D,{method:"post",children:[e.jsx("input",{type:"hidden",name:"intent",value:d?"unblock":"block"}),e.jsxs("button",{type:"submit",className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50",children:[e.jsx("svg",{className:"h-4 w-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"})}),d?"Unblock user":"Block user"]})]}),e.jsxs(O,{to:`/report?type=user&id=${n==null?void 0:n.id}&from=conversation`,className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50",onClick:()=>x(!1),children:[e.jsx("svg",{className:"h-4 w-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),"Report"]}),e.jsx("div",{className:"border-t border-gray-100 my-1"}),e.jsxs("button",{type:"button",onClick:()=>{x(!1),s(!0)},className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50",children:[e.jsx("svg",{className:"h-4 w-4 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"Delete conversation"]})]})]})]}),t&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-sm w-full p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Delete conversation?"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"This conversation will be removed from your inbox. The other user will still be able to see it."}),e.jsxs("div",{className:"mt-4 flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>s(!1),className:"btn-secondary",children:"Cancel"}),e.jsxs(D,{method:"post",children:[e.jsx("input",{type:"hidden",name:"intent",value:"delete"}),e.jsx("button",{type:"submit",className:"btn-primary bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 md:px-8 pb-4",children:e.jsxs("div",{className:"space-y-3",children:[N==null?void 0:N.map((a,y)=>{const j=a.sender_id===h,L=new Date(a.created_at),b=N[y-1],k=b?new Date(b.created_at):null,U=a.message_type==="heart",V=!k||L.toDateString()!==k.toDateString(),I=(b==null?void 0:b.sender_id)===a.sender_id,ee=k?(L.getTime()-k.getTime())/6e4:1/0,S=!I||ee>5||V,T=R(a),M=b?R(b):null,te=I&&(M==null?void 0:M.canToggle)&&!S,Y=T.canToggle&&!te;return e.jsxs("div",{children:[V&&e.jsxs("div",{className:"flex items-center gap-4 my-6",children:[e.jsx("div",{className:"flex-1 h-px bg-gray-200"}),e.jsx("span",{className:"text-xs text-gray-400 font-medium",children:L.toLocaleDateString([],{weekday:"short",day:"numeric",month:"short"})}),e.jsx("div",{className:"flex-1 h-px bg-gray-200"})]}),U?e.jsx("div",{className:"flex justify-center my-6",children:e.jsxs("div",{className:"border border-gray-200 bg-white rounded-2xl px-6 py-4 text-center max-w-sm shadow-sm",children:[e.jsx("div",{className:"flex justify-center mb-2",children:e.jsx("svg",{className:"h-8 w-8 text-red-500",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"})})}),e.jsx("p",{className:"text-gray-800 font-medium",children:"Your listing caught someone's eye"}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"This user saved your listing. Start a conversation."})]})}):(()=>{var q,J;return e.jsxs("div",{className:`flex ${j?"justify-end":"justify-start"}`,children:[!j&&e.jsx("div",{className:`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-xs font-semibold mr-2 ${oe((n==null?void 0:n.id)||"",n==null?void 0:n.user_type)}`,children:((q=n==null?void 0:n.company_name)==null?void 0:q.charAt(0))||((J=n==null?void 0:n.full_name)==null?void 0:J.charAt(0))||"?"}),e.jsxs("div",{className:`flex flex-col ${j?"items-end":"items-start"} max-w-[85%] md:max-w-[70%]`,children:[e.jsxs("div",{className:`rounded-2xl px-4 py-2.5 ${j?"bg-accent-100 text-gray-900 rounded-br-md":"bg-gray-200 text-gray-900 rounded-bl-md"}`,children:[e.jsx("p",{className:"whitespace-pre-wrap break-words",children:T.content}),T.isLoading&&e.jsxs("div",{className:"flex items-center gap-1.5 mt-1.5 text-xs text-gray-400",children:[e.jsxs("svg",{className:"animate-spin h-3 w-3",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("span",{children:"Translating..."})]})]}),(S||j||Y)&&e.jsxs("div",{className:`flex items-center gap-2 text-xs mt-1 px-1 ${j?"flex-row-reverse":"flex-row"}`,children:[S&&e.jsx("span",{className:j?"text-accent-600":"text-gray-500",children:L.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),j&&e.jsx("span",{className:"flex items-center",children:a.read_at?e.jsx("svg",{className:"w-4 h-4 text-blue-500",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"})}):e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"})})}),Y&&e.jsxs("button",{type:"button",onClick:()=>Q(a.id),className:"flex items-center gap-1 text-gray-400 hover:text-gray-600 transition-colors",children:[e.jsx("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"})}),e.jsx("span",{children:T.showOriginal?"Show translation":"Auto-translated â€¢ Show original"})]})]})]})]})})()]},a.id)}),e.jsx("div",{ref:p})]})}),e.jsxs("div",{className:"border-t border-gray-200 px-2 pt-4 pb-3 md:p-4 bg-white",children:[u&&"error"in u&&e.jsx("p",{className:"text-sm text-red-600 mb-2",children:u.error}),d?e.jsx("p",{className:"text-sm text-gray-500 text-center py-2",children:"You have blocked this user. Unblock to send messages."}):e.jsxs(D,{ref:g,method:"post",className:"flex gap-2 md:gap-3 items-end",onSubmit:()=>{var y;const a=(y=f.current)==null?void 0:y.value;a!=null&&a.trim()&&X(a.trim())},children:[e.jsx("textarea",{ref:f,name:"content",placeholder:"Write a message...",autoComplete:"off",required:!0,rows:1,className:"input flex-1 resize-none py-2 md:py-3 px-3 md:px-4 min-h-[40px] md:min-h-[48px] max-h-[150px] overflow-hidden rounded-2xl",disabled:o,onChange:Z}),e.jsx("button",{type:"submit",disabled:o,className:"btn-primary px-2 md:px-4 h-10 md:h-12 flex items-center justify-center rounded-2xl",children:o?e.jsxs("svg",{className:"animate-spin h-5 w-5",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 5l7 7m0 0l-7 7m7-7H3"})})})]})]})]})});export{pe as default,he as meta};
