import{j as e}from"./jsx-runtime-0DLF9kdB.js";import{H as y}from"./Header-BVlwBq23.js";import{r as g,u as N,f as _,L as b,O as v}from"./components-Oo-HIKtb.js";import{g as j}from"./supabase.client-CjZ7LRWJ.js";function M({userId:n,initialConversations:d}){const[u,i]=g.useState(d);return g.useEffect(()=>{i(d)},[d]),g.useEffect(()=>{if(!n||typeof window>"u")return;let l;return(()=>{try{l=j().channel(`conversations:${n}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},x=>{const r=x.new;i(o=>o.map(t=>t.id===r.conversation_id?{...t,updated_at:r.created_at,messages:[...t.messages||[],r]}:t).sort((t,c)=>new Date(c.updated_at).getTime()-new Date(t.updated_at).getTime()))}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages"},x=>{const r=x.new;i(o=>o.map(t=>{var c;return t.id===r.conversation_id?{...t,messages:(c=t.messages)==null?void 0:c.map(m=>m.id===r.id?{...m,read_at:r.read_at}:m)}:t}))}).subscribe()}catch(s){console.error("Error setting up conversations realtime:",s)}})(),()=>{l&&j().removeChannel(l)}},[n]),{conversations:u,setConversations:i}}function $(n){const d=new Date(n),i=new Date().getTime()-d.getTime(),l=Math.floor(i/6e4),a=Math.floor(i/36e5),s=Math.floor(i/864e5);return l<1?"now":l<60?`${l}m`:a<24?`${a}h`:s<7?`${s}d`:d.toLocaleDateString()}function C(){const{user:n,conversations:d}=N(),i=_().id,{conversations:l}=M({userId:n.id,initialConversations:d});return e.jsxs("div",{className:"h-screen flex flex-col bg-gray-50",children:[e.jsx(y,{user:n}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsxs("div",{className:"mx-auto max-w-7xl h-full flex px-4 sm:px-6 lg:px-8 py-16",children:[e.jsxs("aside",{className:`w-full md:w-80 lg:w-96 bg-white border border-gray-200 border-r-0 rounded-l-lg flex flex-col overflow-hidden ${i?"hidden md:flex":"flex"}`,children:[e.jsx("div",{className:"p-4 border-b border-gray-200 flex items-center h-[72px]",children:e.jsx("h1",{className:"font-display text-xl font-bold text-gray-900",children:"Messages"})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:l.length>0?e.jsx("div",{className:"divide-y divide-gray-100",children:l.map(a=>{var c,m,p,h;const s=a.participant_1===n.id?a.participant2:a.participant1,r=[...a.messages||[]].sort((f,w)=>new Date(w.created_at).getTime()-new Date(f.created_at).getTime())[0],o=(c=a.messages)==null?void 0:c.filter(f=>f.sender_id!==n.id&&!f.read_at).length,t=a.id===i;return e.jsxs(b,{to:`/messages/${a.id}`,className:`flex items-center gap-3 p-4 hover:bg-gray-50 transition-colors ${t?"bg-gray-100":""}`,children:[e.jsx("div",{className:`flex h-12 w-12 items-center justify-center rounded-full font-semibold flex-shrink-0 ${t?"bg-gray-600 text-white":"bg-brand-100 text-brand-700"}`,children:((m=s==null?void 0:s.company_name)==null?void 0:m.charAt(0))||((p=s==null?void 0:s.full_name)==null?void 0:p.charAt(0))||"?"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:`font-medium truncate text-sm ${o>0?"text-gray-900":"text-gray-600"}`,children:(s==null?void 0:s.company_name)||(s==null?void 0:s.full_name)||"User"}),r&&e.jsx("span",{className:"text-xs text-gray-400 flex-shrink-0",children:$(r.created_at)})]}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:((h=a.listing)==null?void 0:h.title)||"Listing"}),r&&e.jsxs("p",{className:`text-sm truncate mt-0.5 ${o>0?"text-gray-900 font-medium":"text-gray-500"}`,children:[r.sender_id===n.id&&e.jsx("span",{className:"text-gray-400",children:"You: "}),r.content]})]}),o>0&&!t&&e.jsx("div",{className:"h-3 w-3 rounded-full bg-red-500 flex-shrink-0"})]},a.id)})}):e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-300",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),e.jsx("p",{className:"mt-4 text-sm text-gray-500",children:"No messages yet"}),e.jsx(b,{to:"/listings",className:"mt-4 btn-primary inline-block text-sm",children:"Browse Listings"})]})})]}),e.jsx("main",{className:`flex-1 flex flex-col ${i?"flex":"hidden md:flex"}`,children:e.jsx(v,{context:{user:n,conversations:l}})})]})})]})}export{C as default};
