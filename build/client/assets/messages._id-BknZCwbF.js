import{r as i,d as P,w as I,u as Y,a as q,e as J,c as G,j as e,L as T,F as _}from"./chunk-JZWAC4HX-Wpy6LLBq.js";import{g as K}from"./avatarColors-CZJ_YuDz.js";const Q=3e3;function X(){if(!(typeof window>"u"))try{const x=new Audio("/ding-sound.mp3");x.volume=.5,x.play().catch(()=>{})}catch{}}function Z({conversationId:x,initialMessages:y,currentUserId:u,onNewMessage:o}){const[c,f]=i.useState(y),m=P(),p=i.useRef(!1),g=i.useRef(y.length);return i.useEffect(()=>{f(y),g.current=y.length},[x]),i.useEffect(()=>{var j;if((j=m.data)!=null&&j.messages&&m.state==="idle"){const d=m.data.messages;f(t=>{const r=t.filter(l=>l.id.startsWith("temp-")).filter(l=>!d.some(s=>s.sender_id===l.sender_id&&s.content===l.content));if(g.current<d.length){const l=d.slice(g.current);let h=!1;l.forEach(s=>{s.sender_id!==u&&(o==null||o(s),h=!0)}),h&&X()}return g.current=d.length,r.length>0?[...d,...r].sort((l,h)=>new Date(l.created_at).getTime()-new Date(h.created_at).getTime()):d})}},[m.data,m.state,u,o]),i.useEffect(()=>{if(!x||typeof window>"u")return;const d=setInterval(()=>{p.current||m.state==="idle"&&(p.current=!0,m.load(`/api/messages/${x}`),p.current=!1)},Q);return()=>{clearInterval(d)}},[x,m]),{messages:c,isConnected:!0,setMessages:f}}function U({userId:x,messages:y,enabled:u=!0}){const[o,c]=i.useState({}),[f,m]=i.useState("en"),p=i.useRef(new Set);i.useEffect(()=>{var n;const t=((n=navigator.language)==null?void 0:n.split("-")[0])||"en";m(t)},[]);const g=i.useCallback(async t=>{const n=t.id;if(!n.startsWith("temp-")&&t.sender_id!==x&&!p.current.has(n)){if(t.translated_content&&t.translated_to===f){c(r=>({...r,[n]:{translatedContent:t.translated_content,detectedLanguage:t.detected_language||null,isLoading:!1,error:null,showOriginal:!1}}));return}if(t.detected_language===f){c(r=>({...r,[n]:{translatedContent:null,detectedLanguage:t.detected_language,isLoading:!1,error:null,showOriginal:!1}}));return}p.current.add(n),c(r=>({...r,[n]:{translatedContent:null,detectedLanguage:null,isLoading:!0,error:null,showOriginal:!1}}));try{const r=await fetch("/api/translate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messageId:n,targetLanguage:f})}),l=await r.json();if(!r.ok)throw new Error(l.error||"Translation failed");c(h=>({...h,[n]:{translatedContent:l.translatedContent,detectedLanguage:l.detectedLanguage,isLoading:!1,error:null,showOriginal:!1}}))}catch(r){console.error("Translation error:",r),c(l=>({...l,[n]:{translatedContent:null,detectedLanguage:null,isLoading:!1,error:r instanceof Error?r.message:"Translation failed",showOriginal:!1}}))}finally{p.current.delete(n)}}},[x,f]);i.useEffect(()=>{u&&y.forEach(t=>{var n,r;((n=o[t.id])==null?void 0:n.translatedContent)===void 0&&((r=o[t.id])!=null&&r.isLoading||g(t))})},[y,u,g,o]);const j=i.useCallback(t=>{c(n=>{var r;return{...n,[t]:{...n[t],showOriginal:!((r=n[t])!=null&&r.showOriginal)}}})},[]),d=i.useCallback(t=>{const n=o[t.id];return t.sender_id===x?{content:t.content,isTranslated:!1,isLoading:!1,showOriginal:!1,canToggle:!1}:n?n.isLoading?{content:t.content,isTranslated:!1,isLoading:!0,showOriginal:!1,canToggle:!1}:n.translatedContent?n.showOriginal?{content:t.content,isTranslated:!1,isLoading:!1,showOriginal:!0,canToggle:!0,originalContent:t.content,translatedContent:n.translatedContent}:{content:n.translatedContent,isTranslated:!0,isLoading:!1,showOriginal:!1,canToggle:!0,originalContent:t.content,translatedContent:n.translatedContent}:{content:t.content,isTranslated:!1,isLoading:!1,showOriginal:!1,canToggle:!1}:{content:t.content,isTranslated:!1,isLoading:!1,showOriginal:!1,canToggle:!1}},[o,x]);return{translations:o,browserLanguage:f,translateMessage:g,toggleShowOriginal:j,getDisplayContent:d}}const ne=()=>[{title:"Conversation - Runoot"}],se=I(function(){var M,O,S,D;const{user:y,conversation:u,isBlocked:o}=Y(),c=q(),f=J();G();const m=i.useRef(null),p=i.useRef(null),g=i.useRef(null),[j,d]=i.useState(!1),[t,n]=i.useState(!1),r=i.useRef(null),l=f.state==="submitting",h=y.id,s=u.participant_1===h?u.participant2:u.participant1,{messages:b,setMessages:E}=Z({conversationId:u.id,initialMessages:u.messages||[],currentUserId:h}),{getDisplayContent:B,toggleShowOriginal:A}=U({userId:h,messages:b,enabled:!0});i.useEffect(()=>{function a(v){r.current&&!r.current.contains(v.target)&&d(!1)}return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[]);const W=a=>{const v={id:`temp-${Date.now()}`,conversation_id:u.id,sender_id:h,content:a,created_at:new Date().toISOString(),read_at:null};E(w=>[...w,v])};i.useEffect(()=>{var a;f.state==="idle"&&c&&"success"in c&&c.success&&((a=m.current)==null||a.reset(),g.current&&(g.current.style.height="auto"),d(!1))},[f.state,c]),i.useEffect(()=>{var a;(a=p.current)==null||a.scrollIntoView({behavior:"smooth"})},[b]);const $=a=>{a.target.style.height="auto",a.target.style.height=Math.min(a.target.scrollHeight,150)+"px"};return e.jsxs("div",{className:"flex-1 flex flex-col bg-white/95 backdrop-blur-sm rounded-r-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-4 p-4 border-b border-gray-200 h-[72px]",children:[e.jsx(T,{to:"/messages",className:"md:hidden text-gray-400 hover:text-gray-600 flex-shrink-0",children:e.jsx("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("div",{className:`flex h-10 w-10 items-center justify-center rounded-full font-semibold flex-shrink-0 ${K((s==null?void 0:s.id)||"",s==null?void 0:s.user_type)}`,children:((M=s==null?void 0:s.company_name)==null?void 0:M.charAt(0))||((O=s==null?void 0:s.full_name)==null?void 0:O.charAt(0))||"?"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("p",{className:"font-medium text-gray-900 truncate flex items-center gap-1",children:[(s==null?void 0:s.company_name)||(s==null?void 0:s.full_name)||"User",(s==null?void 0:s.is_verified)&&e.jsx("svg",{className:"h-4 w-4 text-brand-500",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),o&&e.jsx("span",{className:"text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full ml-2",children:"Blocked"})]}),e.jsx(T,{to:`/listings/${(S=u.listing)==null?void 0:S.id}`,className:"text-sm text-brand-600 hover:text-brand-700 truncate block",children:(D=u.listing)==null?void 0:D.title})]}),e.jsxs("div",{className:"relative",ref:r,children:[e.jsx("button",{type:"button",onClick:()=>d(!j),className:"p-3 -m-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center",children:e.jsx("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"})})}),j&&e.jsxs("div",{className:"absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50",children:[e.jsxs(_,{method:"post",children:[e.jsx("input",{type:"hidden",name:"intent",value:o?"unblock":"block"}),e.jsxs("button",{type:"submit",className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50",children:[e.jsx("svg",{className:"h-4 w-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"})}),o?"Unblock user":"Block user"]})]}),e.jsxs(T,{to:`/report?type=user&id=${s==null?void 0:s.id}&from=conversation`,className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50",onClick:()=>d(!1),children:[e.jsx("svg",{className:"h-4 w-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),"Report"]}),e.jsx("div",{className:"border-t border-gray-100 my-1"}),e.jsxs("button",{type:"button",onClick:()=>{d(!1),n(!0)},className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50",children:[e.jsx("svg",{className:"h-4 w-4 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"Delete conversation"]})]})]})]}),t&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-sm w-full p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Delete conversation?"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"This conversation will be removed from your inbox. The other user will still be able to see it."}),e.jsxs("div",{className:"mt-4 flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>n(!1),className:"btn-secondary",children:"Cancel"}),e.jsxs(_,{method:"post",children:[e.jsx("input",{type:"hidden",name:"intent",value:"delete"}),e.jsx("button",{type:"submit",className:"btn-primary bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-8 py-4",children:e.jsxs("div",{className:"space-y-3",children:[b==null?void 0:b.map((a,v)=>{const w=a.sender_id===h,C=new Date(a.created_at),N=b[v-1],L=N?new Date(N.created_at):null,H=a.message_type==="heart",R=!L||C.toDateString()!==L.toDateString(),F=(N==null?void 0:N.sender_id)===a.sender_id,V=L?(C.getTime()-L.getTime())/6e4:1/0,z=!F||V>5||R;return e.jsxs("div",{children:[R&&e.jsxs("div",{className:"flex items-center gap-4 my-6",children:[e.jsx("div",{className:"flex-1 h-px bg-gray-200"}),e.jsx("span",{className:"text-xs text-gray-400 font-medium",children:C.toLocaleDateString([],{weekday:"short",day:"numeric",month:"short"})}),e.jsx("div",{className:"flex-1 h-px bg-gray-200"})]}),H?e.jsx("div",{className:"flex justify-center my-6",children:e.jsxs("div",{className:"border border-gray-200 bg-white rounded-2xl px-6 py-4 text-center max-w-sm shadow-sm",children:[e.jsx("div",{className:"flex justify-center mb-2",children:e.jsx("svg",{className:"h-8 w-8 text-red-500",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"})})}),e.jsx("p",{className:"text-gray-800 font-medium",children:"Your listing caught someone's eye"}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"This user saved your listing. Start a conversation."})]})}):(()=>{const k=B(a);return e.jsx("div",{className:`flex ${w?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-2xl px-4 py-2.5 ${w?"bg-accent-100 text-gray-900 rounded-br-md":"bg-gray-200 text-gray-900 rounded-bl-md"}`,children:[e.jsx("p",{className:"whitespace-pre-wrap break-words",children:k.content}),k.isLoading&&e.jsxs("div",{className:"flex items-center gap-1.5 mt-1.5 text-xs text-gray-400",children:[e.jsxs("svg",{className:"animate-spin h-3 w-3",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("span",{children:"Translating..."})]}),k.canToggle&&e.jsxs("button",{type:"button",onClick:()=>A(a.id),className:`flex items-center gap-1 mt-1.5 text-xs transition-colors ${w?"text-accent-500 hover:text-accent-700":"text-gray-400 hover:text-gray-600"}`,children:[e.jsx("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"})}),e.jsx("span",{children:k.showOriginal?"Show translation":"Auto-translated â€¢ Show original"})]}),(z||w)&&e.jsxs("div",{className:`flex items-center justify-end gap-1.5 text-xs mt-1 ${w?"text-accent-600":"text-gray-500"}`,children:[z&&e.jsx("span",{children:C.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),w&&e.jsx("span",{className:"flex items-center",children:a.read_at?e.jsx("svg",{className:"w-4 h-4 text-blue-500",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"})}):e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"})})})]})]})})})()]},a.id)}),e.jsx("div",{ref:p})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-4",children:[c&&"error"in c&&e.jsx("p",{className:"text-sm text-red-600 mb-2",children:c.error}),o?e.jsx("p",{className:"text-sm text-gray-500 text-center py-2",children:"You have blocked this user. Unblock to send messages."}):e.jsxs(_,{ref:m,method:"post",className:"flex gap-3 items-end",onSubmit:()=>{var v;const a=(v=g.current)==null?void 0:v.value;a!=null&&a.trim()&&W(a.trim())},children:[e.jsx("textarea",{ref:g,name:"content",placeholder:"Write a message...",autoComplete:"off",required:!0,rows:1,className:"input flex-1 resize-none py-3 min-h-[48px] max-h-[150px] overflow-hidden rounded-2xl",disabled:l,onChange:$}),e.jsx("button",{type:"submit",disabled:l,className:"btn-primary px-4 h-12 flex items-center justify-center rounded-2xl",children:l?e.jsxs("svg",{className:"animate-spin h-5 w-5",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 5l7 7m0 0l-7 7m7-7H3"})})})]})]})]})});export{se as default,ne as meta};
